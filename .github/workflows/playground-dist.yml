name: Playground Dist (Artifact)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Patch ALL lucide imports in packages/ui (ts/tsx/js/jsx/mjs/cjs) and assert none remain
        run: |
          set -e

          echo "=== BEFORE: find any lucide imports/require in packages/ui ==="
          # from 'lucide' / "lucide"
          grep -RIn --include='*.ts'  --include='*.tsx' --include='*.js' --include='*.jsx' --include='*.mjs' --include='*.cjs' \
            "from ['\"]lucide['\"]" packages/ui || true
          # require('lucide') / require("lucide")
          grep -RIn --include='*.ts'  --include='*.tsx' --include='*.js' --include='*.jsx' --include='*.mjs' --include='*.cjs' \
            "require\(['\"]lucide['\"]\)" packages/ui || true
          # import('lucide') dynamic import
          grep -RIn --include='*.ts'  --include='*.tsx' --include='*.js' --include='*.jsx' --include='*.mjs' --include='*.cjs' \
            "import\(['\"]lucide['\"]\)" packages/ui || true

          echo "=== PATCH: replace lucide -> lucide-react in code files ==="
          find packages/ui -type f \( -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" -o -name "*.mjs" -o -name "*.cjs" \) -print0 \
            | xargs -0 sed -i -E "s/from ([\"'])lucide\\1/from \\1lucide-react\\1/g"

          find packages/ui -type f \( -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" -o -name "*.mjs" -o -name "*.cjs" \) -print0 \
            | xargs -0 sed -i -E "s/require\\(([\"'])lucide\\1\\)/require(\\1lucide-react\\1)/g"

          find packages/ui -type f \( -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" -o -name "*.mjs" -o -name "*.cjs" \) -print0 \
            | xargs -0 sed -i -E "s/import\\(([\"'])lucide\\1\\)/import(\\1lucide-react\\1)/g"

          echo "=== AFTER: assert no lucide imports/require remain ==="
          if grep -RIn --include='*.ts'  --include='*.tsx' --include='*.js' --include='*.jsx' --include='*.mjs' --include='*.cjs' \
              -E "from ['\"]lucide['\"]|require\(['\"]lucide['\"]\)|import\(['\"]lucide['\"]\)" packages/ui; then
            echo "ERROR: lucide import/require still exists in packages/ui. Fix the remaining lines above."
            exit 1
          fi

          echo "OK: packages/ui lucide references replaced."

      - name: Install root deps
        run: npm ci

      - name: Build packages (root)
        run: npm run build

      - name: Install playground deps
        run: |
          set -e
          cd playground
          npm install

      - name: Verify sentry plugin exists
        run: |
          set -e
          cd playground
          node -e "console.log(require.resolve('@sentry/vite-plugin'))"

      - name: Build playground dist
        run: |
          set -e
          cd playground
          npm run build

      - name: Zip dist
        run: |
          set -e
          test -d playground/dist
          cd playground
          zip -r playground-dist.zip dist

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: playground-dist
          path: playground/playground-dist.zip
